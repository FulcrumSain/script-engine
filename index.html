<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Script Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Geist+Mono:wght@300;400;500&family=Geist:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async></script>
<style>
/* â”€â”€ RESET â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* â”€â”€ TOKENS â”€â”€ */
:root {
  --ink: #111010;
  --paper: #F5F2EC;
  --cream: #EDE9E0;
  --rule: #D5D0C5;
  --accent: #C8401E;
  --accent-dark: #9E3018;
  --muted: #8A8680;
  --mono: 'Geist Mono', monospace;
  --serif: 'Instrument Serif', Georgia, serif;
  --sans: 'Geist', system-ui, sans-serif;
  --r: 3px;
}

/* â”€â”€ BASE â”€â”€ */
html { font-size: 16px; }
body {
  background: var(--paper);
  color: var(--ink);
  font-family: var(--sans);
  font-weight: 400;
  line-height: 1.6;
  min-height: 100vh;
}

/* â”€â”€ LAYOUT â”€â”€ */
.shell {
  display: grid;
  grid-template-columns: 320px 1fr;
  grid-template-rows: 56px 1fr;
  min-height: 100vh;
}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar {
  grid-column: 1 / -1;
  background: var(--ink);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 28px;
  border-bottom: 1px solid #222;
}
.topbar-brand {
  display: flex;
  align-items: baseline;
  gap: 10px;
}
.topbar-brand .wordmark {
  font-family: var(--serif);
  font-size: 20px;
  color: var(--paper);
  letter-spacing: -0.3px;
}
.topbar-brand .badge {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--accent);
  text-transform: uppercase;
}
.topbar-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

/* Google Sign-In button area */
#g_id_signin {
  transform: scale(0.9);
  transform-origin: right center;
}
.user-info {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #aaa;
  font-size: 13px;
  font-family: var(--mono);
}
.user-info img {
  width: 26px; height: 26px;
  border-radius: 50%;
  border: 1px solid #333;
}
.btn-signout {
  background: none;
  border: 1px solid #333;
  border-radius: var(--r);
  color: #666;
  cursor: pointer;
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 1px;
  padding: 4px 8px;
  text-transform: uppercase;
  transition: all .15s;
}
.btn-signout:hover { border-color: #666; color: #aaa; }

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  background: var(--cream);
  border-right: 1px solid var(--rule);
  padding: 32px 24px;
  display: flex;
  flex-direction: column;
  gap: 28px;
  overflow-y: auto;
}

.sidebar-section-label {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 10px;
}

/* URL input */
.url-field {
  position: relative;
}
.url-field input {
  width: 100%;
  background: white;
  border: 1px solid var(--rule);
  border-radius: var(--r);
  color: var(--ink);
  font-family: var(--mono);
  font-size: 12px;
  padding: 11px 14px;
  outline: none;
  transition: border-color .15s;
}
.url-field input:focus { border-color: var(--accent); }
.url-field input::placeholder { color: var(--muted); }

/* Options */
.option-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid var(--rule);
}
.option-row:last-child { border-bottom: none; }
.option-label {
  font-size: 13px;
  color: var(--ink);
}
.option-sub {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--muted);
  margin-top: 2px;
}

/* Toggle */
.toggle {
  position: relative;
  width: 36px; height: 20px;
  flex-shrink: 0;
}
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute; inset: 0;
  background: var(--rule);
  border-radius: 10px;
  cursor: pointer;
  transition: background .2s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 14px; height: 14px;
  left: 3px; top: 3px;
  background: white;
  border-radius: 50%;
  transition: transform .2s;
}
.toggle input:checked + .toggle-slider { background: var(--accent); }
.toggle input:checked + .toggle-slider::before { transform: translateX(16px); }

/* Generate button */
.btn-generate {
  width: 100%;
  background: var(--accent);
  border: none;
  border-radius: var(--r);
  color: white;
  cursor: pointer;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 500;
  letter-spacing: 1.5px;
  padding: 14px;
  text-transform: uppercase;
  transition: background .15s, transform .1s;
  position: relative;
  overflow: hidden;
}
.btn-generate:hover:not(:disabled) { background: var(--accent-dark); }
.btn-generate:active:not(:disabled) { transform: scale(.99); }
.btn-generate:disabled { background: var(--rule); color: var(--muted); cursor: not-allowed; }

.btn-generate .btn-text { transition: opacity .2s; }
.btn-generate.loading .btn-text { opacity: 0; }
.btn-generate .spinner {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; transition: opacity .2s;
}
.btn-generate.loading .spinner { opacity: 1; }
.spin-ring {
  width: 16px; height: 16px;
  border: 2px solid rgba(255,255,255,.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Status */
.status-msg {
  font-family: var(--mono);
  font-size: 11px;
  line-height: 1.5;
  min-height: 16px;
  color: var(--muted);
}
.status-msg.error { color: var(--accent); }
.status-msg.success { color: #2A7A4B; }

/* History */
.history-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.history-item {
  background: white;
  border: 1px solid var(--rule);
  border-radius: var(--r);
  cursor: pointer;
  padding: 8px 12px;
  transition: border-color .15s;
}
.history-item:hover { border-color: var(--ink); }
.history-item .h-id {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--muted);
}
.history-item .h-time {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--rule);
  margin-top: 2px;
}
.history-empty {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--rule);
}

/* â”€â”€ MAIN PANEL â”€â”€ */
.main {
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Empty state */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  color: var(--muted);
  padding: 60px;
  text-align: center;
}
.empty-state .empty-icon {
  font-size: 48px;
  opacity: .25;
  line-height: 1;
}
.empty-state .empty-title {
  font-family: var(--serif);
  font-size: 26px;
  color: var(--ink);
  opacity: .3;
}
.empty-state .empty-sub {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--muted);
  opacity: .6;
  max-width: 320px;
  line-height: 1.7;
}

/* Script tabs */
.tabs-bar {
  display: flex;
  align-items: center;
  gap: 0;
  border-bottom: 1px solid var(--rule);
  background: var(--cream);
  padding: 0 28px;
  flex-shrink: 0;
}
.tab {
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--muted);
  cursor: pointer;
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 1px;
  padding: 14px 16px;
  text-transform: uppercase;
  transition: all .15s;
  white-space: nowrap;
}
.tab:hover { color: var(--ink); }
.tab.active {
  border-bottom-color: var(--accent);
  color: var(--ink);
}
.tab-actions {
  margin-left: auto;
  display: flex;
  gap: 8px;
  align-items: center;
}
.btn-action {
  background: none;
  border: 1px solid var(--rule);
  border-radius: var(--r);
  color: var(--muted);
  cursor: pointer;
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 1px;
  padding: 6px 12px;
  text-transform: uppercase;
  transition: all .15s;
  white-space: nowrap;
}
.btn-action:hover { border-color: var(--ink); color: var(--ink); }
.btn-action.primary {
  background: var(--ink);
  border-color: var(--ink);
  color: white;
}
.btn-action.primary:hover { background: #333; }
.btn-action:disabled { opacity: .4; cursor: not-allowed; }

/* Script content */
.scripts-panel {
  flex: 1;
  overflow-y: auto;
  padding: 0;
}

.script-view {
  display: none;
  padding: 40px 48px;
  max-width: 820px;
}
.script-view.active { display: block; }

/* Script typography */
.script-variation-label {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--accent);
  margin-bottom: 6px;
}
.script-title {
  font-family: var(--serif);
  font-size: 28px;
  line-height: 1.2;
  margin-bottom: 32px;
  color: var(--ink);
}
.script-section {
  margin-bottom: 28px;
}
.script-section-label {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--muted);
  border-top: 1px solid var(--rule);
  padding-top: 16px;
  margin-bottom: 12px;
}
.script-section-body {
  font-family: var(--sans);
  font-size: 15px;
  line-height: 1.75;
  color: var(--ink);
  white-space: pre-line;
}
.script-section-body .personal-slot {
  display: block;
  background: #FFF8E6;
  border-left: 3px solid #E8A020;
  border-radius: 0 var(--r) var(--r) 0;
  color: #7A5A10;
  font-family: var(--mono);
  font-size: 12px;
  line-height: 1.6;
  margin: 12px 0;
  padding: 10px 14px;
}
.visual-hook-box {
  background: var(--cream);
  border: 1px solid var(--rule);
  border-radius: var(--r);
  padding: 16px 20px;
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 8px 16px;
}
.vh-label {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--muted);
  padding-top: 2px;
  white-space: nowrap;
}
.vh-value {
  font-size: 14px;
  line-height: 1.5;
  color: var(--ink);
}
.vh-value strong {
  font-weight: 600;
  font-family: var(--mono);
  font-size: 13px;
}

/* Raw view */
.raw-view {
  display: none;
  padding: 40px 48px;
}
.raw-view.active { display: block; }
.raw-textarea {
  width: 100%;
  min-height: 600px;
  background: var(--cream);
  border: 1px solid var(--rule);
  border-radius: var(--r);
  color: var(--ink);
  font-family: var(--mono);
  font-size: 12px;
  line-height: 1.8;
  padding: 20px;
  resize: vertical;
  outline: none;
}

/* Doc URL toast */
.doc-toast {
  position: fixed;
  bottom: 28px;
  right: 28px;
  background: var(--ink);
  color: white;
  border-radius: var(--r);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 13px;
  box-shadow: 0 8px 32px rgba(0,0,0,.2);
  transform: translateY(80px);
  opacity: 0;
  transition: all .3s cubic-bezier(.34,1.56,.64,1);
  z-index: 999;
  max-width: 380px;
}
.doc-toast.show { transform: translateY(0); opacity: 1; }
.doc-toast a {
  color: var(--accent);
  font-family: var(--mono);
  font-size: 12px;
  text-decoration: none;
  border-bottom: 1px solid var(--accent);
}
.doc-toast a:hover { color: white; border-color: white; }

/* Responsive */
@media (max-width: 768px) {
  .shell { grid-template-columns: 1fr; grid-template-rows: 56px auto 1fr; }
  .sidebar { border-right: none; border-bottom: 1px solid var(--rule); }
  .script-view, .raw-view { padding: 24px; }
}

/* Animations */
.script-view { animation: fadeUp .3s ease; }
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

<div class="shell">

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-brand">
      <span class="wordmark">Script Engine</span>
      <span class="badge">v1.0</span>
    </div>
    <div class="topbar-right">
      <!-- Google Sign-In (shown when not signed in) -->
      <div id="googleSignInArea">
        <div id="g_id_onload"
          data-client_id="YOUR_GOOGLE_CLIENT_ID"
          data-callback="handleCredentialResponse"
          data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
          id="g_id_signin"
          data-type="standard"
          data-size="small"
          data-theme="filled_black"
          data-text="sign_in_with"
          data-shape="pill"
          data-logo_alignment="left">
        </div>
      </div>
      <!-- User info (shown when signed in) -->
      <div id="userInfo" class="user-info" style="display:none">
        <img id="userAvatar" src="" alt="">
        <span id="userName"></span>
        <button class="btn-signout" onclick="signOut()">Sign out</button>
      </div>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside class="sidebar">

    <div>
      <div class="sidebar-section-label">YouTube URL</div>
      <div class="url-field">
        <input type="text" id="urlInput" placeholder="https://youtube.com/watch?v=..." autocomplete="off" />
      </div>
    </div>

    <div>
      <div class="sidebar-section-label">Options</div>
      <div class="option-row">
        <div>
          <div class="option-label">Export to Google Docs</div>
          <div class="option-sub">Requires Google sign-in</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="exportToggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <div>
      <button class="btn-generate" id="generateBtn" onclick="generate()">
        <span class="btn-text">Generate Scripts</span>
        <span class="spinner"><span class="spin-ring"></span></span>
      </button>
      <div class="status-msg" id="statusMsg" style="margin-top:10px"></div>
    </div>

    <div>
      <div class="sidebar-section-label">Recent</div>
      <div class="history-list" id="historyList">
        <div class="history-empty">No scripts generated yet.</div>
      </div>
    </div>

  </aside>

  <!-- MAIN PANEL -->
  <main class="main" id="mainPanel">

    <!-- Empty state -->
    <div class="empty-state" id="emptyState">
      <div class="empty-icon">âœ¦</div>
      <div class="empty-title">Paste a link. Get five scripts.</div>
      <div class="empty-sub">Drop any YouTube URL into the sidebar, hit Generate, and five camera-ready script variations will be waiting for you.</div>
    </div>

    <!-- Script tabs (hidden until generation) -->
    <div class="tabs-bar" id="tabsBar" style="display:none">
      <button class="tab active" onclick="switchTab('v1')" id="tab-v1">V1 Hot Take</button>
      <button class="tab" onclick="switchTab('v2')" id="tab-v2">V2 Data</button>
      <button class="tab" onclick="switchTab('v3')" id="tab-v3">V3 Story</button>
      <button class="tab" onclick="switchTab('v4')" id="tab-v4">V4 Question</button>
      <button class="tab" onclick="switchTab('v5')" id="tab-v5">V5 Preview</button>
      <button class="tab" onclick="switchTab('raw')" id="tab-raw">Raw</button>
      <div class="tab-actions">
        <button class="btn-action" onclick="copyCurrentScript()">Copy</button>
        <button class="btn-action" onclick="copyAllScripts()">Copy All</button>
        <button class="btn-action primary" id="docBtn" onclick="exportToDoc()" disabled>Open in Docs â†—</button>
      </div>
    </div>

    <!-- Script views -->
    <div class="scripts-panel" id="scriptsPanel" style="display:none">
      <div class="script-view active" id="view-v1"></div>
      <div class="script-view" id="view-v2"></div>
      <div class="script-view" id="view-v3"></div>
      <div class="script-view" id="view-v4"></div>
      <div class="script-view" id="view-v5"></div>
      <div class="raw-view" id="view-raw">
        <textarea class="raw-textarea" id="rawTextarea" readonly></textarea>
      </div>
    </div>

  </main>
</div>

<!-- Doc URL toast -->
<div class="doc-toast" id="docToast">
  <span>ðŸ“„ Doc created</span>
  <a id="docLink" href="" target="_blank">Open in Google Docs â†’</a>
</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Set this to your deployed backend URL after deploying to Render/Railway
// For local dev, use 'http://localhost:5000'
const API_URL = window.location.hostname === 'localhost'
  ? 'http://localhost:5000'
  : 'https://YOUR-BACKEND-URL.onrender.com'; // â† update after deploy

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let googleAccessToken = null;
let currentScripts = null;
let currentDocUrl = null;
let activeTab = 'v1';
let history = JSON.parse(localStorage.getItem('sg_history') || '[]');

// â”€â”€ GOOGLE AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleCredentialResponse(response) {
  // This is the ID token â€” we need to exchange for access token
  // For Google Docs API we need OAuth2, not just ID token.
  // The sign-in below handles proper OAuth2 access token flow.
  console.log("ID token received:", response.credential);
}

function initGoogleAuth() {
  // Use Google Identity Services for OAuth2 access token (needed for Docs API)
  window.tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: 'YOUR_GOOGLE_CLIENT_ID', // â† set this
    scope: 'https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file profile email',
    callback: (tokenResponse) => {
      if (tokenResponse.access_token) {
        googleAccessToken = tokenResponse.access_token;
        // Get user info
        fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
          headers: { Authorization: `Bearer ${googleAccessToken}` }
        }).then(r => r.json()).then(info => {
          document.getElementById('googleSignInArea').style.display = 'none';
          document.getElementById('userInfo').style.display = 'flex';
          document.getElementById('userName').textContent = info.name;
          document.getElementById('userAvatar').src = info.picture;
        });
      }
    }
  });
}

function signIn() {
  if (window.tokenClient) window.tokenClient.requestAccessToken();
}

function signOut() {
  googleAccessToken = null;
  document.getElementById('googleSignInArea').style.display = 'flex';
  document.getElementById('userInfo').style.display = 'none';
  document.getElementById('exportToggle').checked = false;
}

// Wire up Google Sign-In button to OAuth2 flow
window.addEventListener('load', () => {
  // Replace the g_id_signin div with a proper button for OAuth2
  const area = document.getElementById('googleSignInArea');
  const btn = document.createElement('button');
  btn.className = 'btn-action';
  btn.textContent = 'Sign in with Google';
  btn.style.color = '#ccc';
  btn.style.borderColor = '#444';
  btn.onclick = () => {
    if (window.google && window.tokenClient) {
      signIn();
    } else {
      // Load Google Identity Services if not already loaded
      const script = document.createElement('script');
      script.src = 'https://accounts.google.com/gsi/client';
      script.onload = () => {
        initGoogleAuth();
        signIn();
      };
      document.head.appendChild(script);
    }
  };
  const signinDiv = document.getElementById('g_id_signin');
  if (signinDiv) signinDiv.replaceWith(btn);

  // Initialise if GIS already loaded
  if (window.google) initGoogleAuth();
  else {
    document.querySelector('script[src*="gsi/client"]')?.addEventListener('load', initGoogleAuth);
  }

  renderHistory();
});

// â”€â”€ GENERATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generate() {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) { setStatus('Paste a YouTube URL first.', 'error'); return; }

  const exportEnabled = document.getElementById('exportToggle').checked;
  if (exportEnabled && !googleAccessToken) {
    setStatus('Sign in with Google to export to Docs.', 'error');
    return;
  }

  setLoading(true);
  setStatus('Fetching transcriptâ€¦');

  try {
    const body = { url };
    if (exportEnabled && googleAccessToken) body.access_token = googleAccessToken;

    const res = await fetch(`${API_URL}/generate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Unknown error');

    currentScripts = data.scripts;
    currentDocUrl = data.doc_url || null;

    setStatus(
      data.doc_url
        ? '5 scripts generated + exported to Docs âœ“'
        : '5 scripts generated âœ“',
      'success'
    );

    renderScripts(data.scripts, data.video_id);
    saveHistory(data.video_id, url);

    if (data.doc_url) showDocToast(data.doc_url);
    if (data.doc_warning) setStatus(data.doc_warning, 'error');

  } catch (e) {
    setStatus(e.message, 'error');
  } finally {
    setLoading(false);
  }
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderScripts(rawText, videoId) {
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('tabsBar').style.display = 'flex';
  document.getElementById('scriptsPanel').style.display = 'block';

  // Raw view
  document.getElementById('rawTextarea').value = rawText;

  // Parse the 5 scripts out of the raw markdown
  const scripts = parseScripts(rawText);
  const hookTypes = ['Hot Take', 'Data / Insight', 'Story', 'Question', 'Preview'];
  const ids = ['v1','v2','v3','v4','v5'];

  ids.forEach((id, i) => {
    const view = document.getElementById(`view-${id}`);
    const script = scripts[i] || { hook:'', visualHook:'', body:'', close:'' };
    view.innerHTML = buildScriptHTML(id.toUpperCase(), hookTypes[i], script);
  });

  switchTab('v1');
  updateDocBtn();
}

function parseScripts(text) {
  // Split on ## V1 through ## V5 markers
  const sections = text.split(/\n(?=## V\d)/);
  return sections.slice(0, 5).map(section => {
    const hook = extractSection(section, 'HOOK', 'VISUAL HOOK');
    const visualHook = extractSection(section, 'VISUAL HOOK', 'BODY');
    const body = extractSection(section, 'BODY', 'CLOSE');
    const close = extractSection(section, 'CLOSE', null);
    return { hook, visualHook, body, close };
  });
}

function extractSection(text, name, nextName) {
  const startMarker = `### ${name}`;
  const startIdx = text.indexOf(startMarker);
  if (startIdx === -1) return '';
  let endIdx = text.length;
  if (nextName) {
    const ni = text.indexOf(`### ${nextName}`, startIdx);
    if (ni !== -1) endIdx = ni;
  }
  return text.slice(startIdx + startMarker.length, endIdx).trim();
}

function buildScriptHTML(varNum, hookType, script) {
  const bodyHtml = formatBody(script.body);
  const visualHtml = formatVisualHook(script.visualHook);
  return `
    <div class="script-variation-label">Variation ${varNum}</div>
    <div class="script-title">${hookType} Hook</div>

    <div class="script-section">
      <div class="script-section-label">Hook</div>
      <div class="script-section-body">${escHtml(script.hook)}</div>
    </div>

    <div class="script-section">
      <div class="script-section-label">Visual Hook</div>
      ${visualHtml}
    </div>

    <div class="script-section">
      <div class="script-section-label">Body</div>
      <div class="script-section-body">${bodyHtml}</div>
    </div>

    <div class="script-section">
      <div class="script-section-label">Close</div>
      <div class="script-section-body">${escHtml(script.close)}</div>
    </div>
  `;
}

function formatBody(body) {
  return body.split('\n').map(line => {
    if (line.match(/^\[PERSONAL STORY SLOT/i)) {
      return `<span class="personal-slot">${escHtml(line)}</span>`;
    }
    return escHtml(line);
  }).join('\n');
}

function formatVisualHook(text) {
  if (!text) return '<div class="visual-hook-box"><span class="vh-label">â€”</span><span class="vh-value"></span></div>';
  const overlayMatch = text.match(/\*\*Text overlay[:\*]*\*?\*?\s*(.+?)(?:\n|$)/i) ||
                       text.match(/text overlay[:\s]+(.+?)(?:\n|$)/i);
  const visualMatch  = text.match(/\*\*Opening visual[:\*]*\*?\*?\s*(.+?)(?:\n|$)/i) ||
                       text.match(/opening visual[:\s]+(.+?)(?:\n|$)/i);

  const overlay = overlayMatch ? overlayMatch[1].trim().replace(/\*\*/g,'') : '';
  const visual  = visualMatch  ? visualMatch[1].trim().replace(/\*\*/g,'') : text;

  return `
    <div class="visual-hook-box">
      <span class="vh-label">Text</span>
      <span class="vh-value"><strong>${escHtml(overlay)}</strong></span>
      <span class="vh-label">Camera</span>
      <span class="vh-value">${escHtml(visual)}</span>
    </div>
  `;
}

function escHtml(str) {
  return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(id) {
  activeTab = id;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`tab-${id}`).classList.add('active');
  document.querySelectorAll('.script-view, .raw-view').forEach(v => v.classList.remove('active'));
  document.getElementById(`view-${id}`).classList.add('active');
}

// â”€â”€ COPY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyCurrentScript() {
  if (!currentScripts) return;
  const scripts = parseScripts(currentScripts);
  const ids = ['v1','v2','v3','v4','v5'];
  const idx = ids.indexOf(activeTab);
  if (idx === -1) { navigator.clipboard.writeText(currentScripts); return; }
  const s = scripts[idx];
  const text = `HOOK\n${s.hook}\n\nVISUAL HOOK\n${s.visualHook}\n\nBODY\n${s.body}\n\nCLOSE\n${s.close}`;
  navigator.clipboard.writeText(text).then(() => setStatus('Copied âœ“', 'success'));
}

function copyAllScripts() {
  if (!currentScripts) return;
  navigator.clipboard.writeText(currentScripts).then(() => setStatus('All scripts copied âœ“', 'success'));
}

// â”€â”€ GOOGLE DOCS EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDocBtn() {
  const btn = document.getElementById('docBtn');
  if (currentDocUrl) {
    btn.disabled = false;
    btn.textContent = 'Open in Docs â†—';
  } else {
    btn.disabled = !googleAccessToken;
    btn.textContent = googleAccessToken ? 'Export to Docs' : 'Sign in for Docs';
  }
}

async function exportToDoc() {
  if (currentDocUrl) {
    window.open(currentDocUrl, '_blank');
    return;
  }
  if (!googleAccessToken || !currentScripts) return;

  setStatus('Exporting to Google Docsâ€¦');
  try {
    const res = await fetch(`${API_URL}/generate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        url: document.getElementById('urlInput').value.trim(),
        access_token: googleAccessToken,
        scripts_override: currentScripts
      })
    });
    const data = await res.json();
    if (data.doc_url) {
      currentDocUrl = data.doc_url;
      showDocToast(data.doc_url);
      setStatus('Exported to Google Docs âœ“', 'success');
      updateDocBtn();
    }
  } catch(e) {
    setStatus(`Export failed: ${e.message}`, 'error');
  }
}

function showDocToast(url) {
  const toast = document.getElementById('docToast');
  const link = document.getElementById('docLink');
  link.href = url;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 7000);
}

// â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveHistory(videoId, url) {
  history.unshift({ videoId, url, time: Date.now() });
  history = history.slice(0, 10);
  localStorage.setItem('sg_history', JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const list = document.getElementById('historyList');
  if (!history.length) {
    list.innerHTML = '<div class="history-empty">No scripts generated yet.</div>';
    return;
  }
  list.innerHTML = history.map(h => `
    <div class="history-item" onclick="loadHistory('${h.url}')">
      <div class="h-id">${h.videoId}</div>
      <div class="h-time">${timeAgo(h.time)}</div>
    </div>
  `).join('');
}

function loadHistory(url) {
  document.getElementById('urlInput').value = url;
}

function timeAgo(ts) {
  const diff = Date.now() - ts;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
  if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
  return `${Math.floor(diff/86400000)}d ago`;
}

// â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(on) {
  const btn = document.getElementById('generateBtn');
  btn.disabled = on;
  btn.classList.toggle('loading', on);
}

function setStatus(msg, type = '') {
  const el = document.getElementById('statusMsg');
  el.textContent = msg;
  el.className = 'status-msg ' + type;
}

// Enter key
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('urlInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') generate();
  });
});
</script>
</body>
</html>
